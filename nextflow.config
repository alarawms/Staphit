/*
 * Staphit - MRSA Pathogen Tracker
 * Nextflow Configuration for IBEX Cluster
 */

// Pipeline parameters
params {
    input       = 'samplesheet.csv'
    outdir      = 'results'
}

// Profiles
profiles {
    docker {
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }
    
    ibex {
        process {
            executor = 'slurm'
            queue = 'batch'
            clusterOptions = '--constraint=intel'
            
            // Default resources
            cpus = 4
            memory = '16 GB'
            time = '4h'
            
            // Process-specific resources
            withName: 'SPADES|ASSEMBLY' {
                cpus = 8
                memory = '32 GB'
                time = '8h'
            }
            withName: 'PROKKA|ANNOTATION' {
                cpus = 4
                memory = '16 GB'
                time = '4h'
            }
            withName: 'TRIMMOMATIC' {
                cpus = 4
                memory = '8 GB'
                time = '2h'
            }
        }
        
        singularity {
            enabled = true
            autoMounts = true
            pullTimeout = '60 min'
            cacheDir = "${launchDir}/singularity_cache"
        }
        
        docker {
            enabled = false
        }
        
        env {
            SINGULARITY_CACHEDIR = "${launchDir}/singularity_cache"
            SINGULARITY_TMPDIR = "${launchDir}/singularity_tmp"
        }
    }
}

// Workflow hooks
workflow.onStart {
    // Create cache directories
    def cacheDir = new File("${launchDir}/singularity_cache")
    def tmpDir = new File("${launchDir}/singularity_tmp")
    
    if (!cacheDir.exists()) {
        cacheDir.mkdirs()
        println "Created: ${cacheDir}"
    }
    if (!tmpDir.exists()) {
        tmpDir.mkdirs()
        println "Created: ${tmpDir}"
    }
    
    println """
    ╔═══════════════════════════════════════════════════════════╗
    ║           Staphit - MRSA Pathogen Tracker                 ║
    ╠═══════════════════════════════════════════════════════════╣
    ║  Input       : ${params.input}
    ║  Output      : ${params.outdir}
    ║  Work Dir    : ${workDir}
    ║  Cache Dir   : ${cacheDir}
    ╚═══════════════════════════════════════════════════════════╝
    """.stripIndent()
}

workflow.onComplete {
    println """
    ╔═══════════════════════════════════════════════════════════╗
    ║                    Pipeline Complete                      ║
    ╠═══════════════════════════════════════════════════════════╣
    ║  Status      : ${workflow.success ? 'SUCCESS' : 'FAILED'}
    ║  Duration    : ${workflow.duration}
    ║  Results     : ${params.outdir}
    ╚═══════════════════════════════════════════════════════════╝
    """.stripIndent()
}

workflow.onError {
    println """
    ╔═══════════════════════════════════════════════════════════╗
    ║                    Pipeline Error                         ║
    ╠═══════════════════════════════════════════════════════════╣
    ║  Error: ${workflow.errorMessage}
    ╚═══════════════════════════════════════════════════════════╝
    """.stripIndent()
}

// Manifest
manifest {
    name            = 'Staphit'
    author          = 'alarawms'
    description     = 'MRSA Pathogen Tracker Pipeline'
    mainScript      = 'main.nf'
    version         = '1.0.0'
}

// Reports
report {
    enabled = true
    file = "${params.outdir}/pipeline_report.html"
    overwrite = true
}

timeline {
    enabled = true
    file = "${params.outdir}/timeline.html"
    overwrite = true
}

dag {
    enabled = true
    file = "${params.outdir}/dag.png"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.outdir}/trace.txt"
    overwrite = true
}
