/*
 * Staphit Pipeline - IBEX Configuration
 * MRSA Pathogen Tracker
 */

// Default parameters
params {
    input         = 'samplesheet.csv'
    outdir        = './results'
    
    // Set to null to use samplesheet mode
    // Set to a species name (e.g., 'Staphylococcus aureus') to search NCBI SRA
    species       = null
    search_limit  = 100
    max_downloads = 50
}

// Singularity settings
singularity {
    enabled       = true
    autoMounts    = true
    pullTimeout   = '60 min'
    cacheDir      = "${projectDir}/singularity_cache"
    runOptions    = '--no-home'
}

// Environment variables
env {
    SINGULARITY_CACHEDIR = "${projectDir}/singularity_cache"
    SINGULARITY_TMPDIR   = "${projectDir}/singularity_tmp"
}

// Create directories on pipeline start
workflow.onStart = {
    println "=== Staphit Pipeline ==="
    println "Creating cache directories..."
    
    def cacheDir = new File("${projectDir}/singularity_cache")
    def tmpDir   = new File("${projectDir}/singularity_tmp")
    
    if (!cacheDir.exists()) { cacheDir.mkdirs() }
    if (!tmpDir.exists())   { tmpDir.mkdirs() }
    
    println "Cache dir: ${cacheDir}"
    println "Tmp dir:   ${tmpDir}"
    println "Output:    ${params.outdir}"
    println "Input:     ${params.input}"
    println "Mode:      ${params.species ? 'SRA Search' : 'Samplesheet'}"
    println "========================"
}

// Profiles
profiles {
    
    // IBEX HPC Profile
    ibex {
        process {
            executor       = 'slurm'
            queue          = 'batch'
            clusterOptions = '--constraint=intel'
            
            // Default resources
            cpus   = 4
            memory = 16.GB
            time   = '4h'
            
            // ===== QC & Preprocessing =====
            withName: 'SEARCH_SRA' {
                cpus   = 2
                memory = 4.GB
                time   = '1h'
            }
            withName: 'FETCH_METADATA' {
                cpus   = 2
                memory = 4.GB
                time   = '1h'
            }
            withName: 'FETCH_SRA' {
                cpus   = 2
                memory = 8.GB
                time   = '4h'
            }
            withName: 'TRIMMOMATIC|FASTP' {
                cpus   = 4
                memory = 16.GB
                time   = '2h'
            }
            withName: 'FASTQC' {
                cpus   = 2
                memory = 8.GB
                time   = '1h'
            }
            
            // ===== Assembly =====
            withName: 'SPADES|ASSEMBLY' {
                cpus   = 8
                memory = 64.GB
                time   = '12h'
            }
            withName: 'QUAST' {
                cpus   = 4
                memory = 16.GB
                time   = '2h'
            }
            
            // ===== Species ID & Typing =====
            withName: 'MASH' {
                cpus   = 4
                memory = 16.GB
                time   = '2h'
            }
            withName: 'MLST' {
                cpus   = 2
                memory = 8.GB
                time   = '1h'
            }
            withName: 'SPATYPER' {
                cpus   = 2
                memory = 8.GB
                time   = '1h'
            }
            withName: 'SCCMEC' {
                cpus   = 2
                memory = 8.GB
                time   = '1h'
            }
            withName: 'AGR_TYPING' {
                cpus   = 2
                memory = 8.GB
                time   = '1h'
            }
            
            // ===== AMR & Annotation =====
            withName: 'AMRFINDERPLUS' {
                cpus   = 4
                memory = 16.GB
                time   = '2h'
            }
            withName: 'ABRICATE' {
                cpus   = 4
                memory = 8.GB
                time   = '1h'
            }
            withName: 'PROKKA|ANNOTATION' {
                cpus   = 8
                memory = 32.GB
                time   = '6h'
            }
            
            // ===== Resistance Databases =====
            withName: 'FETCH_RESFINDER_DB' {
                cpus   = 2
                memory = 4.GB
                time   = '1h'
            }
            withName: 'INDEX_DB' {
                cpus   = 2
                memory = 8.GB
                time   = '1h'
            }
            withName: 'KMA' {
                cpus   = 4
                memory = 16.GB
                time   = '2h'
            }
            
            // ===== Pan-genome & Phylogeny =====
            withName: 'PANAROO' {
                cpus   = 8
                memory = 32.GB
                time   = '8h'
            }
            withName: 'IQTREE' {
                cpus   = 8
                memory = 32.GB
                time   = '12h'
            }
            withName: 'SNP_DISTS' {
                cpus   = 4
                memory = 16.GB
                time   = '2h'
            }
            
            // ===== Reporting =====
            withName: 'AGGREGATOR' {
                cpus   = 2
                memory = 8.GB
                time   = '1h'
            }
            withName: 'SUMMARY_MERGER' {
                cpus   = 2
                memory = 8.GB
                time   = '1h'
            }
            withName: 'VISUALIZATION' {
                cpus   = 2
                memory = 8.GB
                time   = '1h'
            }
            withName: 'MULTIQC' {
                cpus   = 2
                memory = 8.GB
                time   = '1h'
            }
        }
        
        singularity.enabled = true
        docker.enabled      = false
    }
    
    // Local testing with Docker
    docker {
        docker.enabled      = true
        singularity.enabled = false
    }
    
    // Local testing with Singularity
    singularity {
        singularity.enabled = true
        docker.enabled      = false
    }
}

// Execution reports
report {
    enabled   = true
    file      = "${params.outdir}/pipeline_report.html"
    overwrite = true
}

timeline {
    enabled   = true
    file      = "${params.outdir}/timeline.html"
    overwrite = true
}

trace {
    enabled   = true
    file      = "${params.outdir}/trace.txt"
    overwrite = true
}

dag {
    enabled   = true
    file      = "${params.outdir}/dag.html"
    overwrite = true
}

// Manifest
manifest {
    name        = 'Staphit'
    description = 'MRSA Pathogen Tracker Pipeline'
    version     = '1.0.0'
    mainScript  = 'main.nf'
}
